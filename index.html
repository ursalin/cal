<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALEB AI</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #video-container { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #loader { position: absolute; display: none; flex-direction: column; align-items: center; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid #3d5afe; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ui { padding: 20px; background: #111; }
        #chat-output { min-height: 40px; margin-bottom: 15px; color: #ccc; border-left: 3px solid #3d5afe; padding-left: 10px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; }
        button { background: #3d5afe; border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="calebVideo" autoplay playsinline poster="https://raw.githubusercontent.com/ursalin/cal/main/mmexport1766446686555.jpg"></video>
        <div id="loader"><div class="spinner"></div><p>正在准备回复...</p></div>
    </div>
    <div id="ui">
        <div id="chat-output">等待连接...</div>
        <div class="input-group">
            <input type="text" id="userInput" placeholder="和TA说点什么...">
            <button id="sendBtn">发送</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('calebVideo');
        const loader = document.getElementById('loader');
        const output = document.getElementById('chat-output');

        document.getElementById('sendBtn').onclick = async () => {
            const text = document.getElementById('userInput').value;
            if (!text) return;

            loader.style.display = 'flex';
            output.innerText = "正在思考...";

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                
                output.innerText = data.reply; // 立即显示文字

                if (data.event_id) {
                    checkStatus(data.event_id);
                } else {
                    loader.style.display = 'none';
                    output.innerText += " (视频生成暂不可用)";
                }
            } catch (e) {
                output.innerText = "连接失败，请检查网络";
                loader.style.display = 'none';
            }
        };

        async function checkStatus(id) {
            const url = `https://kwai-kolors-liveportrait.hf.space/gradio_api/call/predict/${id}`;
            const timer = setInterval(async () => {
                try {
                    const res = await fetch(url);
                    if (res.ok) {
                        const result = await res.json();
                        if (result[0] && result[0].url) {
                            video.src = result[0].url;
                            video.loop = false;
                            loader.style.display = 'none';
                            clearInterval(timer);
                        }
                    }
                } catch (e) { console.error(e); }
            }, 2000);
        }
    </script>
</body>
</html>
