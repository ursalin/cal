<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>和我聊聊吧 - 夏以昼</title>
    <style>
        :root { --main-blue: #7ba2ff; }
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 视频区：确保始终有底图，不会全黑 */
        #video-container { 
            width: 100%; height: 65vh; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        video { 
            width: 100%; height: 100%; object-fit: cover; object-position: center 15%; 
            background: url('https://raw.githubusercontent.com/ursalin/cal/main/mmexport1766446686555.jpg') no-repeat center center;
            background-size: cover;
        }

        /* 加载动画 */
        #loader { position: absolute; display: none; flex-direction: column; align-items: center; z-index: 10; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--main-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* 对话区 */
        #ui-layer { flex: 1; background: #111; padding: 20px; display: flex; flex-direction: column; border-top: 1px solid #222; }
        #chat-output { flex: 1; font-size: 17px; color: #ddd; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .input-group { display: flex; gap: 10px; height: 45px; }
        input { flex: 1; background: #222; border: 1px solid #333; border-radius: 22px; padding: 0 15px; color: #fff; outline: none; }
        button { background: var(--main-blue); border: none; border-radius: 22px; padding: 0 20px; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="calebVideo" autoplay playsinline poster="https://raw.githubusercontent.com/ursalin/cal/main/mmexport1766446686555.jpg"></video>
        <div id="loader"><div class="spinner"></div><p style="font-size:12px; margin-top:10px;">哥正在准备...</p></div>
    </div>

    <div id="ui-layer">
        <div id="chat-output">早呀，想跟哥说点什么？</div>
        <div class="input-group">
            <input type="text" id="userInput" placeholder="输入消息..." autocomplete="off">
            <button id="sendBtn">发送</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('calebVideo');
        const loader = document.getElementById('loader');
        const output = document.getElementById('chat-output');

        document.getElementById('sendBtn').onclick = async () => {
            const text = document.getElementById('userInput').value;
            if (!text) return;

            loader.style.display = 'flex';
            output.innerText = "正在听你说话...";

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                output.innerText = data.reply;

                if (data.event_id) {
                    checkStatus(data.event_id);
                } else {
                    loader.style.display = 'none';
                }
            } catch (e) {
                output.innerText = "信号不太好，再说一次？";
                loader.style.display = 'none';
            }
        };

        async function checkStatus(id) {
            const url = `https://kwai-kolors-liveportrait.hf.space/gradio_api/call/predict/${id}`;
            const timer = setInterval(async () => {
                try {
                    const res = await fetch(url);
                    if (res.ok) {
                        const result = await res.json();
                        if (result[0] && result[0].url) {
                            video.src = result[0].url;
                            video.oncanplay = () => {
                                loader.style.display = 'none';
                                video.play();
                            };
                            clearInterval(timer);
                        }
                    }
                } catch (e) { console.error(e); }
            }, 2000);
        }
    </script>
</body>
</html>
